{
  "requestId": "508122ef-6442-46eb-b2fc-5fab1f4f7064",
  "status": "success",
  "fragment": {
    "AWSTemplateFormatVersion": "2010-09-09",
    "Resources": {
      "PRIVATEEGRESSVPC": {
        "Type": "AWS::EC2::VPC",
        "Properties": {
          "CidrBlock": "172.16.0.0/20",
          "EnableDnsHostnames": true,
          "EnableDnsSupport": true,
          "InstanceTenancy": "default",
          "Tags": [
            {
              "Key": "Name",
              "Value": "PRIVATEEGRESSVPC"
            },
            {
              "Key": "Name",
              "Value": "PRIVATE-EGRESS-VPC"
            },
            {
              "Key": "Template",
              "Value": "VPC for private endpoints egress only"
            }
          ]
        }
      },
      "DhcpOptions": {
        "Type": "AWS::EC2::DHCPOptions",
        "Properties": {
          "DomainNameServers": [
            "172.16.0.2"
          ],
          "NtpServers": [
            "169.254.169.123"
          ],
          "NetbiosNodeType": 2,
          "Tags": [
            {
              "Key": "Name",
              "Value": "DhcpOptions"
            },
            {
              "Key": "Name",
              "Value": "PRIVATE-EGRESS-VPC"
            },
            {
              "Key": "Template",
              "Value": "VPC for private endpoints egress only"
            }
          ]
        }
      },
      "DhcpOptionsAssociation": {
        "Type": "AWS::EC2::VPCDHCPOptionsAssociation",
        "Properties": {
          "DhcpOptionsId": {
            "Ref": "DhcpOptions"
          },
          "VpcId": {
            "Ref": "PRIVATEEGRESSVPC"
          }
        }
      },
      "InternetGateway": {
        "Type": "AWS::EC2::InternetGateway",
        "Properties": {
          "Tags": [
            {
              "Key": "Name",
              "Value": "InternetGateway"
            },
            {
              "Key": "Name",
              "Value": "PRIVATE-EGRESS-VPC"
            },
            {
              "Key": "Template",
              "Value": "VPC for private endpoints egress only"
            }
          ]
        }
      },
      "IGWVPCGatewayAttachment": {
        "Type": "AWS::EC2::VPCGatewayAttachment",
        "Properties": {
          "InternetGatewayId": {
            "Ref": "InternetGateway"
          },
          "VpcId": {
            "Ref": "PRIVATEEGRESSVPC"
          }
        }
      },
      "VPCFlowLogsRole": {
        "Type": "AWS::IAM::Role",
        "Properties": {
          "AssumeRolePolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": [
                    "vpc-flow-logs.amazonaws.com"
                  ]
                },
                "Action": [
                  "sts:AssumeRole"
                ]
              }
            ]
          },
          "Path": "/",
          "Policies": [
            {
              "PolicyName": "Default",
              "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Effect": "Allow",
                    "Action": [
                      "logs:*"
                    ],
                    "Resource": "arn:aws:logs:*:*:defaultflowlogs"
                  }
                ]
              }
            }
          ]
        }
      },
      "VPCFlowLogDefault": {
        "Type": "AWS::EC2::FlowLog",
        "Properties": {
          "DeliverLogsPermissionArn": {
            "Fn::GetAtt": [
              "VPCFlowLogsRole",
              "Arn"
            ]
          },
          "LogDestinationType": "cloud-watch-logs",
          "LogGroupName": "defaultflowlogs",
          "ResourceId": {
            "Ref": "PRIVATEEGRESSVPC"
          },
          "ResourceType": "VPC",
          "TrafficType": "ALL"
        }
      },
      "VPCFlowLogS3Style": {
        "Type": "AWS::EC2::FlowLog",
        "Properties": {
          "LogDestination": "arn:aws:s3:::S3Style",
          "LogDestinationType": "s3",
          "ResourceId": {
            "Ref": "PRIVATEEGRESSVPC"
          },
          "ResourceType": "VPC",
          "TrafficType": "ALL"
        }
      },
      "S3StyleS3BucketPolicy": {
        "Properties": {
          "Bucket": {
            "Ref": "S3StyleS3Bucket"
          },
          "PolicyDocument": {
            "Statement": [
              {
                "Sid": "AWSLogDeliveryWrite",
                "Effect": "Allow",
                "Principal": {
                  "Service": "delivery.logs.amazonaws.com"
                },
                "Action": "s3:PutObject",
                "Resource": [
                  {
                    "Fn::Sub": "arn:aws:s3:::S3Style/AWSLogs/${AWS::AccountId}/*"
                  }
                ],
                "Condition": {
                  "StringEquals": {
                    "s3:x-amz-acl": "bucket-owner-full-control"
                  }
                }
              },
              {
                "Sid": "AWSLogDeliveryAclCheck",
                "Effect": "Allow",
                "Principal": {
                  "Service": "delivery.logs.amazonaws.com"
                },
                "Action": "s3:GetBucketAcl",
                "Resource": "arn:aws:s3:::S3Style"
              }
            ]
          }
        },
        "Type": "AWS::S3::BucketPolicy"
      },
      "S3StyleS3Bucket": {
        "Properties": {
          "BucketName": "S3Style",
          "Tags": [
            {
              "Key": "Name",
              "Value": "S3Style"
            },
            {
              "Key": "Description",
              "Value": "Bucket for VPCFlowlog: S3Style"
            }
          ],
          "PublicAccessBlockConfiguration": {
            "BlockPublicAcls": true,
            "BlockPublicPolicy": true,
            "IgnorePublicAcls": true,
            "RestrictPublicBuckets": true
          },
          "BucketEncryption": {
            "ServerSideEncryptionConfiguration": [
              {
                "ServerSideEncryptionByDefault": {
                  "KMSMasterKeyID": {
                    "Fn::GetAtt": [
                      "S3StyleKMSKey",
                      "Arn"
                    ]
                  },
                  "SSEAlgorithm": "aws:kms"
                }
              }
            ]
          }
        },
        "Type": "AWS::S3::Bucket"
      },
      "S3StyleKMSKey": {
        "Type": "AWS::KMS::Key",
        "Properties": {
          "Description": "Key for VPCFlowLogs: S3Style and S3 Bucket: S3Style",
          "EnableKeyRotation": true,
          "KeyPolicy": {
            "Version": "2012-10-17",
            "Id": "S3Style-vpcflowlog",
            "Statement": [
              {
                "Sid": "Allows admin of the key",
                "Effect": "Allow",
                "Principal": {
                  "AWS": {
                    "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:root"
                  }
                },
                "Action": [
                  "kms:Create*",
                  "kms:Describe*",
                  "kms:Enable*",
                  "kms:List*",
                  "kms:Put*",
                  "kms:Update*",
                  "kms:Revoke*",
                  "kms:Disable*",
                  "kms:Get*",
                  "kms:Delete*",
                  "kms:ScheduleKeyDeletion",
                  "kms:CancelKeyDeletion"
                ],
                "Resource": "*"
              },
              {
                "Sid": "Allow VPCFlowLogs",
                "Effect": "Allow",
                "Principal": {
                  "Service": [
                    "delivery.logs.amazonaws.com"
                  ]
                },
                "Action": [
                  "kms:Encrypt",
                  "kms:Decrypt",
                  "kms:ReEncrypt*",
                  "kms:GenerateDataKey*",
                  "kms:DescribeKey"
                ],
                "Resource": "*"
              }
            ]
          }
        }
      }
    },
    "Description": "Private VPC Template",
    "Parameters": {},
    "Mappings": {},
    "Outputs": {
      "PRIVATEEGRESSVPC": {
        "Description": "PRIVATEEGRESSVPC",
        "Value": {
          "Ref": "PRIVATEEGRESSVPC"
        },
        "Export": {
          "Name": {
            "Fn::Sub": "${AWS::StackName}-VPCid"
          }
        }
      },
      "S3StyleS3Bucket": {
        "Value": {
          "Fn::GetAtt": [
            "S3StyleS3Bucket",
            "Arn"
          ]
        },
        "Export": {
          "Name": {
            "Fn::Sub": "${AWS::StackName}-S3-S3Style-Arn"
          }
        }
      },
      "S3StyleS3BucketDomainName": {
        "Value": {
          "Fn::GetAtt": [
            "S3StyleS3Bucket",
            "DualStackDomainName"
          ]
        },
        "Export": {
          "Name": {
            "Fn::Sub": "${AWS::StackName}-S3-S3Style-DomainName"
          }
        }
      }
    }
  }
}